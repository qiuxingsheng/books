# 第4章 存储高性能
## 4.1 关系数据库
### 4.1.1 读写分离
基本实现
1. 数据库服务器搭建主从集群，一主一从、一主多从都可以
2. 主机负责读写，从机值负责读
3. 主机通过复制将数据同步到从机
4. 业务服务器将写操作发给主机，读操作发给从机

读写分离需要应对复制延带来的复杂性，以Mysql为例，主从复制延迟可能达到1s，常用方法如下
1. 写操作后的读操作指定发给数据库主机
2. 读从机失败后再读一次主机
3. 关键业务读写操作全部指向主机，非关键业务采用读写分离

### 4.1.2 分库分表
数据量过大会使单台服务器的存储能力成为系统瓶颈
1. 数据量太大，读写性能下降，及时有索引，索引也会变得很大，性能下降
2. 数据文件会变得很大，数据库备份和恢复需要耗费很长时间
3. 数据文件越大，极端情况下丢数据的风险越高

常见分库分表的方案如下

方案一. 分库

业务分库指按业务模块将数据进行拆分。例如将一个电商系统的数据库，拆分为用户、商品、订单三台数据库

虽然业务分库能分散存储和访问压力，但同时带来新的问题
1. 无法像单库进行方便的join操作
2. 事务问题
3. 成本问题 占用的服务器数量上升

方案二. 分表

a. 垂直分表

垂直分表适合将表中某些不常用且占了大量空间的列拆分出去。


b. 水平分表

水平分表适合行数特别大的表，如果单表行数超过5000万（该数字可做参考）就必须分表。
水平分表会引入很多复杂性，主要表现在
1. 路由 ，需要增加路由算法计算某条数据具体属于哪个切分后的子表
   1. 范围路由， 例如按照用户id进行分段，以1~1000w为一张子表
      1. 优点：可以随数据增加而平滑地扩充新表
      2. 缺点：数据分布不均匀
   2. Hash路由 根据某个列的值进行Hash运算，根据结果分散到不同的表中
      1. 优点：表分布比较均匀
      2. 缺点：扩充新表很麻烦，所有数据都要重分布
   3. 配置路由 用一张独立的路由表来记录记录的分布信息
      1. 优点：设计简单，扩充表灵活
      2. 缺点：必须多查询一次，影响性能；路由表过大也会成为性能瓶颈
2. join操作 需要在代码中进行多次join，然后结果合并
3. count()操作
   1. count()相加 在代码中处理
   2. 记录数表 
4. 排序操作 只能在代码中处理











